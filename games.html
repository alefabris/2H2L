<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Games | Z4NE.zone</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="activities.html">Activities</a></li>
      <li><a href="games.html">Games</a></li>
      <li><a href="join.html" class="join-button">Join</a></li>
    </ul>
  </nav>

  <div class="games-wrapper">
    <h1>Games</h1>

    <div class="filter-controls">
      <label>
        Players:
        <select id="playerFilter">
          <option value="">Any</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="5">5+</option>
          <option value="6">6+</option>
        </select>
      </label>

      <label>
        Duration:
        <select id="timeFilter">
          <option value="">Any</option>
          <option value="30">≤ 30'</option>
          <option value="60">≤ 60'</option>
          <option value="90">≤ 90'</option>
          <option value="120">≤ 120'</option>
        </select>
      </label>

      <label>
        Owner:
        <select id="ownerFilter">
          <option value="">All</option>
          <option value="gasca98">gasca98</option>
          <option value="RushHD">RushHD</option>
        </select>
      </label>

      <button id="clearFilters" class="clear-filters">Reset Filters</button>
    </div>
  </div>

  <script>
    const gamesWrapper = document.querySelector('.games-wrapper');
    const playerFilter = document.getElementById('playerFilter');
    const timeFilter = document.getElementById('timeFilter');
    const ownerFilter = document.getElementById('ownerFilter');
    const clearFilters = document.getElementById('clearFilters');

    async function fetchGames() {
      const res = await fetch('games/index.json');
      const gameSlugs = await res.json();

      const gameHTMLs = await Promise.all(gameSlugs.map(async (slug) => {
        const res = await fetch(`games/${slug}.json`);
        const game = await res.json();
        return renderGameHTML(game);
      }));

      gamesWrapper.insertAdjacentHTML('beforeend', gameHTMLs.join(''));
      filterGames();
    }

    function renderGameHTML(game) {
      const [minPlayers, maxPlayers] = game.players.split('-').map(n => parseInt(n.trim()));
      const classes = ['game'];
      if (game.comingSoon) classes.push('coming-soon');

      const expansions = (game.expansions || []).map(exp => `
        <div class="expansion">
          <a href="${exp.url}" target="_blank">
            ${exp.title}
            ${exp.note ? `<span class="expansion-note"><img src="assets/icons/player-purple.svg" class="emoji-icon">${exp.note}</span>` : ''}
          </a>
          <span>${exp.description}</span>
        </div>
      `).join('');

      return `
        <div class="${classes.join(' ')}" data-players="${game.players}" ${game.playersWithExpansion ? `data-players-with-expansion="${game.playersWithExpansion}"` : ''}>
          <div class="game-meta">
            <span><img src="assets/icons/player-purple.svg" class="emoji-icon" />: ${game.players} ${game.playersWithExpansion ? `(+${game.playersWithExpansion - maxPlayers} with expansion)` : ''} |
            <img src="assets/icons/time-purple.svg" class="emoji-icon" />: ${game.time}'</span>
          </div>
          <h2><a href="${game.url}" target="_blank">${game.title}</a></h2>
          <p>${game.description}</p>
          ${expansions}
          <small class="owner">(${game.owner})</small>
        </div>
      `;
    }

    function updateURLParams() {
      const params = new URLSearchParams();
      if (playerFilter.value) params.set('players', playerFilter.value);
      if (timeFilter.value) params.set('time', timeFilter.value);
      if (ownerFilter.value) params.set('owner', ownerFilter.value);
      history.replaceState({}, '', '?' + params.toString());
    }

    function getURLParams() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('players')) playerFilter.value = params.get('players');
      if (params.has('time')) timeFilter.value = params.get('time');
      if (params.has('owner')) ownerFilter.value = params.get('owner');
    }

    function filterGames() {
      const games = document.querySelectorAll('.game');
      const selectedPlayers = parseInt(playerFilter.value);
      const selectedTime = parseInt(timeFilter.value);
      const selectedOwner = ownerFilter.value;

      games.forEach(game => {
        const metaText = game.querySelector('.game-meta')?.textContent || '';
        const timeMatch = metaText.match(/(\d+)\s*–?\s*(\d+)?'/);
        const minTime = timeMatch ? parseInt(timeMatch[1]) : null;

        const dataPlayers = game.dataset.players || '';
        const expansionMax = parseInt(game.dataset.playersWithExpansion || '0');
        const [min, max] = dataPlayers.split('-').map(n => parseInt(n.trim()));

        let matchPlayers = true;
        let matchTime = true;

        if (!isNaN(selectedPlayers)) {
          matchPlayers = selectedPlayers >= min && selectedPlayers <= max;
          const existingWarn = game.querySelector('.expansion-warning');
          if (!matchPlayers && selectedPlayers <= expansionMax) {
            matchPlayers = true;
            if (!existingWarn) {
              const warn = document.createElement('div');
              warn.className = 'expansion-warning';
              warn.innerHTML = `<img src="assets/icons/warning-purple.svg" class="emoji-icon"> Requires expansion to support ${selectedPlayers} players`;
              game.appendChild(warn);
            }
          } else if (existingWarn) {
            existingWarn.remove();
          }
        }

        if (!isNaN(selectedTime) && minTime !== null) {
          matchTime = minTime <= selectedTime;
        }

        const ownerEl = game.querySelector('.owner');
        const gameOwner = ownerEl ? ownerEl.textContent.match(/\(([^)]+)\)/)?.[1] : null;
        const matchOwner = !selectedOwner || gameOwner === selectedOwner;

        game.style.display = (matchPlayers && matchTime && matchOwner) ? '' : 'none';
      });

      updateURLParams();
    }

    clearFilters.addEventListener('click', () => {
      playerFilter.value = '';
      timeFilter.value = '';
      ownerFilter.value = '';
      document.querySelectorAll('.expansion-warning').forEach(w => w.remove());
      filterGames();
    });

    playerFilter.addEventListener('change', filterGames);
    timeFilter.addEventListener('change', filterGames);
    ownerFilter.addEventListener('change', filterGames);

    window.addEventListener('DOMContentLoaded', () => {
      getURLParams();
      fetchGames();
    });
  </script>
</body>
</html>
