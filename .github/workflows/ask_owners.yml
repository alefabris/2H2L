name: Ask Game Owners for Availability

on:
  schedule:
    - cron: "0 9 * * 3"  # Every Wednesday at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ask_owners:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract unique owners and build poll message
        id: build_poll
        run: |
          mkdir -p .tmp

          # Collect all owners from games/*.json excluding comingSoon
          jq -r '.[] | select(.comingSoon != true) | .owner' games/*.json | sort -u > .tmp/owners.txt

          # Build poll message
          echo "ðŸ§© **Game Owners â€“ Will you be there the next week?**\n\nReact with:\nâœ… Yes\nâŒ No\n\n" > owner_poll_message.txt
          while read -r OWNER; do
            echo "âœ… ${OWNER}" >> owner_poll_message.txt
          done < .tmp/owners.txt

      - name: Post poll message to Discord
        id: post_poll
        run: |
          MSG_CONTENT=$(jq -Rs . < owner_poll_message.txt | sed 's/\\\\n/\\n/g')
          RESPONSE=$(curl -s -X POST "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": $MSG_CONTENT}")

          echo "$RESPONSE" > .owner_poll_response.json
          MESSAGE_ID=$(jq -r '.id' .owner_poll_response.json)
          echo "$MESSAGE_ID" > .owner_poll_id
          echo "OWNER_POLL_ID=$MESSAGE_ID" >> $GITHUB_ENV

      - name: Add âœ… and âŒ reactions to the poll
        run: |
          for EMOJI in "âœ…" "âŒ"; do
            ENCODED=$(printf "%s" "$EMOJI" | jq -sRr @uri)
            curl -s -X PUT "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages/${OWNER_POLL_ID}/reactions/${ENCODED}/@me" \
              -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" > /dev/null
          done

      - name: Fetch âœ… reactions and resolve present owners
        run: |
          # Fetch user reactions to âœ…
          ENCODED=$(printf "âœ…" | jq -sRr @uri)
          RESPONSE=$(curl -s "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages/${OWNER_POLL_ID}/reactions/${ENCODED}?limit=100" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}")

          echo "$RESPONSE" > .tmp/reacted_yes.json

          # Extract Discord usernames
          jq -r '.[].username' .tmp/reacted_yes.json | sort -u > .tmp/reacted_usernames.txt

          # Map Discord usernames to internal owner keys
          touch .present_owners
          while read -r DISCORD_USERNAME; do
            OWNER=$(jq -r --arg user "$DISCORD_USERNAME" '.[$user] // empty' .owners_map.json)
            if [ -n "$OWNER" ]; then
              echo "$OWNER" >> .present_owners
            fi
          done < .tmp/reacted_usernames.txt

          sort -u .present_owners -o .present_owners

      - name: Commit poll ID and present owners
        run: |
          git config --global user.name "poll-bot"
          git config --global user.email "bot@example.com"
          git add .owner_poll_id .present_owners
          git commit -m "Update present game owners"
          git push
