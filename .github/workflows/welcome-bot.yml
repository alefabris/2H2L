name: Welcome Bot

on:
  schedule:
    - cron: "*/5 * * * *"  # every 5 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  welcome_bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Create temp storage if missing
        run: mkdir -p .tmp && touch .tmp/seen_users.txt

      - name: Fetch new messages from welcome channel
        id: fetch_messages
        env:
          TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.DISCORD_WELCOME_CHANNEL_ID }}
        run: |
          curl -s -H "Authorization: Bot $TOKEN" \
            "https://discord.com/api/v10/channels/$CHANNEL_ID/messages?limit=20" > .tmp/welcome_messages.json

      - name: Process new users
        env:
          TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          MOD_CHANNEL: ${{ secrets.DISCORD_MOD_CHANNEL_ID }}
        run: |
          SEEN_FILE=".tmp/seen_users.txt"
          jq -r '.[].author | "\(.id):\(.username)"' .tmp/welcome_messages.json | while IFS=: read -r ID USER; do
            if ! grep -q "$ID" "$SEEN_FILE"; then
              echo "ðŸ‘‹ New user: $USER ($ID)"
              
              # Notify mods
              MSG="ðŸ‘¤ **${USER}** just introduced themselves in #welcome!"
              curl -s -X POST "https://discord.com/api/v10/channels/$MOD_CHANNEL/messages" \
                -H "Authorization: Bot $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"content\": \"$MSG\"}" > /dev/null

              # OPTIONAL: Send DM to user (comment out if not needed)
              curl -s -X POST "https://discord.com/api/v10/users/@me/channels" \
                -H "Authorization: Bot $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"recipient_id\": \"$ID\"}" > .tmp/dm_channel.json
              
              DM_CHANNEL_ID=$(jq -r '.id' .tmp/dm_channel.json)

              curl -s -X POST "https://discord.com/api/v10/channels/$DM_CHANNEL_ID/messages" \
                -H "Authorization: Bot $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"content\": \"ðŸ‘‹ Welcome to Z4NE.zone, $USER! A mod will review your intro soon. Thanks for joining!\"}" > /dev/null

              # Mark user as seen
              echo "$ID" >> "$SEEN_FILE"
            fi
          done

      - name: Save seen list
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .tmp/seen_users.txt
          git commit -m "Track new welcomed users" || echo "No new users"
          git push
