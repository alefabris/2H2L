name: Post Owner Poll

on:
  schedule:
    - cron: "0 9 * * 3"  # Every Wednesday at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  post_owners_poll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build poll message from owners.json
        run: |
          echo "ðŸ§© **Game Owners â€“ Will you be there the next week?**" > owner_poll_message.txt
          echo "" >> owner_poll_message.txt
          echo "React with your emoji to confirm presence:" >> owner_poll_message.txt
          echo "" >> owner_poll_message.txt

          i=0
          EMOJIS=(ðŸ‡¦ ðŸ‡§ ðŸ‡¨ ðŸ‡© ðŸ‡ª ðŸ‡« ðŸ‡¬ ðŸ‡­ ðŸ‡® ðŸ‡¯ ðŸ‡° ðŸ‡± ðŸ‡² ðŸ‡³ ðŸ‡´ ðŸ‡µ ðŸ‡¶ ðŸ‡· ðŸ‡¸ ðŸ‡¹ ðŸ‡º ðŸ‡» ðŸ‡¼ ðŸ‡½ ðŸ‡¾ ðŸ‡¿)
          jq -r '.[]' games/owners.json | while read -r OWNER; do
            echo "${EMOJIS[i]} ${OWNER}" >> owner_poll_message.txt
            echo "" >> owner_poll_message.txt
            i=$((i+1))
          done

      - name: Post message to Discord
        run: |
          MSG_CONTENT=$(jq -Rs . < owner_poll_message.txt | sed 's/\\\\n/\\n/g')

          curl -s -X POST "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": $MSG_CONTENT}" > /dev/null
