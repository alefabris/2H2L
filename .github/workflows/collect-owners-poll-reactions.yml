name: Collect Owner Poll Reactions

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect_owner_votes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch last owner poll message
        id: fetch_last_message
        run: |
          curl -s "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages?limit=1" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" > .tmp/latest_owner_poll.json

          jq -r '.[0].id' .tmp/latest_owner_poll.json > .owner_poll_id

      - name: Fetch reactions and save results
        run: |
          mkdir -p results
          OWNER_POLL_ID=$(cat .owner_poll_id)
          EMOJIS=(ðŸ‡¦ ðŸ‡§ ðŸ‡¨ ðŸ‡© ðŸ‡ª ðŸ‡« ðŸ‡¬ ðŸ‡­ ðŸ‡® ðŸ‡¯ ðŸ‡° ðŸ‡± ðŸ‡² ðŸ‡³ ðŸ‡´ ðŸ‡µ ðŸ‡¶ ðŸ‡· ðŸ‡¸ ðŸ‡¹ ðŸ‡º ðŸ‡» ðŸ‡¼ ðŸ‡½ ðŸ‡¾ ðŸ‡¿)
          OWNERS=($(jq -r '.[]' games/owners.json))

          NOW=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          TODAY=$(date -u +'%Y-%m-%d')

          echo "{" > owners-results.json
          echo "  \"owners\": [" >> owners-results.json

          for i in "${!OWNERS[@]}"; do
            EMOJI="${EMOJIS[i]}"
            OWNER="${OWNERS[i]}"

            ENCODED=$(printf "%s" "$EMOJI" | jq -sRr @uri)
            COUNT=$(curl -s "https://discord.com/api/v10/channels/${{ secrets.DISCORD_OWNERS_CHANNEL_ID }}/messages/${OWNER_POLL_ID}/reactions/${ENCODED}?limit=100" \
              -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" | jq length)

            if [ "$i" -gt 0 ]; then echo "," >> owners-results.json; fi
            echo "    {\"owner\": \"$OWNER\", \"votes\": $((COUNT - 1))}" >> owners-results.json
          done

          echo "  ]," >> owners-results.json
          echo "  \"generatedAt\": \"${NOW}\"" >> owners-results.json
          echo "}" >> owners-results.json

          cp owners-results.json "results/owners-${TODAY}.json"

      - name: Commit owner poll results
        run: |
          git config --global user.name "poll-bot"
          git config --global user.email "bot@example.com"
          git add owners-results.json results/owners-*.json
          git commit -m "Update owner poll results" || echo "No changes to commit"
          git push || echo "Nothing to push"
