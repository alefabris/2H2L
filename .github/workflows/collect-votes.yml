name: Collect Poll Votes

on:
  schedule:
    #- cron: "*/5 * * * *"  # Every 5 minutes
    - cron: "*/1 * 1* * *"  # Every day 1* of the month
  workflow_dispatch:

jobs:
  collect_votes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read poll message ID
        run: echo "MESSAGE_ID=$(cat .poll_id)" >> "$GITHUB_ENV"

      - name: Get poll message from Discord (with debug output)
        run: |
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X GET "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages/${MESSAGE_ID}" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}")

          echo "$RESPONSE" | tee full_response.txt

          HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d: -f2)
          JSON_CONTENT=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Failed to fetch poll message. Status: $HTTP_STATUS"
            echo "$JSON_CONTENT"
            exit 1
          fi

          echo "$JSON_CONTENT" > .poll_message.json

      - name: Generate results.json and history
        run: |
          mkdir -p results

          GAMES=$(jq -r '.[]' games/index.json)
          EMOJIS=(ðŸ‡¦ ðŸ‡§ ðŸ‡¨ ðŸ‡© ðŸ‡ª ðŸ‡« ðŸ‡¬ ðŸ‡­ ðŸ‡® ðŸ‡¯ ðŸ‡° ðŸ‡± ðŸ‡² ðŸ‡³ ðŸ‡´ ðŸ‡µ ðŸ‡¶ ðŸ‡· ðŸ‡¸ ðŸ‡¹ ðŸ‡º ðŸ‡» ðŸ‡¼ ðŸ‡½ ðŸ‡¾ ðŸ‡¿)

          # Safe parse even if no reactions
          jq -r '.reactions[]? | "\(.emoji.name) \(.count)"' .poll_message.json > .reaction_counts.txt

          NOW=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          TODAY=$(date -u +'%Y-%m-%d')

          echo "{" > results.json
          echo "  \"votes\": [" >> results.json

          i=0
          while read -r GAME; do
            EMOJI="${EMOJIS[i]}"
            VOTES=$(grep "$EMOJI" .reaction_counts.txt | awk '{print $2}' || echo "0")
            if [ $i -gt 0 ]; then echo "," >> results.json; fi
            echo "    {\"game\": \"$GAME\", \"votes\": $((VOTES - 1))}" >> results.json
            i=$((i + 1))
          done <<< "$GAMES"

          echo "  ]," >> results.json
          echo "  \"generatedAt\": \"${NOW}\"" >> results.json
          echo "}" >> results.json

          cp results.json "results/${TODAY}.json"

      - name: Commit results to repo
        run: |
          git config --global user.name "poll-bot"
          git config --global user.email "bot@example.com"
          git add results.json results/*.json
          git commit -m "Update poll results and archive"
          git push
