name: Post Weekly Board Game Poll

on:
  schedule:
    - cron: "0 10 * * 4"  # Every Thursday at 10:00 UTC
  workflow_dispatch:  # Allow manual run

jobs:
  post_poll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read game list and send poll to Discord
        run: |
          echo "Reading game list from /games/index.json..."
          GAMES=$(jq -r '.[]' games/index.json)

          EMOJIS=(ðŸ‡¦ ðŸ‡§ ðŸ‡¨ ðŸ‡© ðŸ‡ª ðŸ‡« ðŸ‡¬ ðŸ‡­ ðŸ‡® ðŸ‡¯ ðŸ‡° ðŸ‡± ðŸ‡² ðŸ‡³ ðŸ‡´)
          MSG="ðŸŽ² **Vote for this week's board game!**\nReact with the emoji to vote:\n"

          i=0
          while read -r GAME; do
            if [ $i -ge ${#EMOJIS[@]} ]; then
              echo "Too many games (max 15 supported). Skipping: $GAME"
              continue
            fi
            MSG+="${EMOJIS[i]} ${GAME}\n"
            i=$((i + 1))
          done <<< "$GAMES"

          echo "Sending message to Discord..."

          curl -X POST "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"${MSG}\"}"

      - name: Done
        run: echo "Poll posted successfully."
