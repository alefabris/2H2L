name: Post Weekly Board Game Poll

on:
  schedule:
    - cron: "0 9 * * 4"  # Every Thursday at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write  # Required to push .poll_id file

jobs:
  post_poll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read games and post poll message
        run: |
          GAMES=$(jq -r '.[]' games/index.json)
          EMOJIS=(ğŸ‡¦ ğŸ‡§ ğŸ‡¨ ğŸ‡© ğŸ‡ª ğŸ‡« ğŸ‡¬ ğŸ‡­ ğŸ‡® ğŸ‡¯ ğŸ‡° ğŸ‡± ğŸ‡² ğŸ‡³ ğŸ‡´ ğŸ‡µ ğŸ‡¶ ğŸ‡· ğŸ‡¸ ğŸ‡¹ ğŸ‡º ğŸ‡» ğŸ‡¼ ğŸ‡½ ğŸ‡¾ ğŸ‡¿)

          MSG="ğŸ² **Vote for the week's board game!**\nReact with the emoji to vote:\n"

          i=0
          while read -r GAME; do
            MSG+="${EMOJIS[i]} ${GAME}\n"
            i=$((i + 1))
          done <<< "$GAMES"

          RESPONSE=$(curl -s -X POST "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages" \
            -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$MSG\"}")

          echo "$RESPONSE" > .poll_response.json
          MESSAGE_ID=$(jq -r '.id' .poll_response.json)

          if [[ "$MESSAGE_ID" == "null" || -z "$MESSAGE_ID" ]]; then
            echo "âŒ Failed to post poll. Response:"
            cat .poll_response.json
            exit 1
          fi

          echo "$MESSAGE_ID" > .poll_id
          echo "MESSAGE_ID=$MESSAGE_ID" >> $GITHUB_ENV

      - name: Add emoji reactions to poll
        run: |
          GAMES=$(jq -r '.[]' games/index.json)
          EMOJIS=(ğŸ‡¦ ğŸ‡§ ğŸ‡¨ ğŸ‡© ğŸ‡ª ğŸ‡« ğŸ‡¬ ğŸ‡­ ğŸ‡® ğŸ‡¯ ğŸ‡° ğŸ‡± ğŸ‡² ğŸ‡³ ğŸ‡´ ğŸ‡µ ğŸ‡¶ ğŸ‡· ğŸ‡¸ ğŸ‡¹ ğŸ‡º ğŸ‡» ğŸ‡¼ ğŸ‡½ ğŸ‡¾ ğŸ‡¿)

          i=0
          while read -r _; do
            EMOJI=${EMOJIS[i]}
            EMOJI_ENC=$(printf "%s" "$EMOJI" | jq -sRr @uri)

            echo "Adding reaction $EMOJI..."
            curl -s -X PUT "https://discord.com/api/v10/channels/${{ secrets.DISCORD_CHANNEL_ID }}/messages/${MESSAGE_ID}/reactions/${EMOJI_ENC}/@me" \
              -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" > /dev/null

            sleep 0.5  # Helps avoid Discord rate limits
            i=$((i + 1))
          done <<< "$GAMES"

      - name: Commit and push poll ID
        run: |
          git config --global user.name "poll-bot"
          git config --global user.email "bot@example.com"
          git add .poll_id
          git commit -m "Save poll message ID"
          git push
